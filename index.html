<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kinesys 重量・消費電力 計算ツール</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --ring:#334155;
    }
    html,body{height:100%;}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:linear-gradient(180deg,#0b1220,#0f172a); color:var(--text);
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .app{ width:min(1024px,100%); }
    .card{ background:rgba(17,24,39,.75); backdrop-filter: blur(8px); border:1px solid var(--ring); border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h1{ font-size:clamp(20px,2.8vw,28px); margin:0 0 8px; letter-spacing:.3px }
    p.lead{ margin:0 0 16px; color:var(--muted)}
    .grid{ display:grid; gap:16px; grid-template-columns: repeat(12,1fr); }
    .col-3{ grid-column: span 3; }
    .col-4{ grid-column: span 4; }
    .col-6{ grid-column: span 6; }
    .col-8{ grid-column: span 8; }
    .col-12{ grid-column: span 12; }
    label{ display:block; font-size:14px; color:var(--muted); margin-bottom:6px; }
    input, select, textarea{ width:100%; padding:12px 14px; border-radius:12px; background:#0b1220; color:var(--text); border:1px solid var(--ring); outline:none; }
    input:focus, select:focus, textarea:focus{ border-color: var(--accent); box-shadow:0 0 0 3px rgba(34,197,94,.15); }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap: wrap;}
    .btn{ cursor:pointer; border:none; padding:10px 14px; border-radius:12px; background:var(--accent); color:#052e16; font-weight:700; }
    .btn.secondary{ background:#1f2937; color:var(--text); border:1px solid var(--ring); }
    .btn.ghost{ background:transparent; color:var(--text); border:1px dashed var(--ring); }
    .outputs{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-top:8px; }
    .out{ background:#0b1220; border:1px dashed var(--ring); border-radius:12px; padding:16px; }
    .out h3{ margin:0 0 6px; font-size:16px; color:var(--muted) }
    .out .val{ font-size:40px; font-weight:800; letter-spacing:.4px }
    details{ margin-top:18px; }
    summary{ cursor:pointer; font-weight:700; padding:10px 0; color:#c7d2fe }
    .mini{ font-size:12px; color:var(--muted); }
    .footer{ margin-top:12px; font-size:12px; color:var(--muted); }
    .warn{ color:#fca5a5; font-size:12px; }
  </style>
</head>
<body>
  <div class="app card">
    <h1>Kinesys 重量・消費電力 計算ツール</h1>
    <p class="lead">モーターの種類、台数を選択してください。</p>

    <div class="grid">
      <div class="col-6">
        <label for="model">モーター</label>
        <select id="model">
          <option value="">— 選択してください —</option>
          <option>CM</option>
          <option>Liftket</option>
          <option>Trolley</option>
          <option>Rotator</option>
        </select>
      </div>
      <div class="col-6">
        <label for="qty">台数</label>
        <input id="qty" type="number" inputmode="numeric" min="0" step="1" placeholder="例: 4" value="0">
      </div>

      <div class="col-12">
        <details close>
          <summary>Data値の設定</summary>
          <div class="grid" style="margin-top:10px; gap:12px">
            <div class="col-3">
              <label>CM 本体重量（kg）</label>
              <input id="wCM" type="number" step="0.1" placeholder="例: 35" value="97">
            </div>
            <div class="col-3">
              <label>Liftket 本体重量（kg）</label>
              <input id="wLiftket" type="number" step="0.1" placeholder="例: 32" value="69.7">
            </div>
            <div class="col-3">
              <label>Trolley 本体重量（kg）</label>
              <input id="wTrolley" type="number" step="0.1" placeholder="例: 18" value="26">
            </div>
            <div class="col-3">
              <label>Rotator 本体重量（kg）</label>
              <input id="wRotator" type="number" step="0.1" placeholder="例: 22" value="24">
            </div>


            <div class="col-3">
              <label>CM 消費電力（W）</label>
              <input id="pCM" type="number" step="1" placeholder="例: 500" value="8">
            </div>
            <div class="col-3">
              <label>Liftket 消費電力（W）
              </label>
              <input id="pLiftket" type="number" step="1" placeholder="例: 450" value="5">
            </div>
            <div class="col-3">
              <label>Trolley 消費電力（W）</label>
              <input id="pTrolley" type="number" step="1" placeholder="例: 300" value="1.5">
            </div>
            <div class="col-3">
              <label>Rotator 消費電力（W）</label>
              <input id="pRotator" type="number" step="1" placeholder="例: 350" value="1.5">
            </div>

            

            <div class="col-3">
              <label>Elevation 1+ 重量（kg）</label>
              <input id="wExtra" type="number" step="0.1" placeholder="例: 3" value="11.5">
            </div>




          </div>
          <p class="mini">参照：重量 = <code>(Data!D[機種] + Data!D7) * C3</code>、消費電力 = <code>Data!C[機種] * C3</code></p>

          <div class="row" style="margin-top:8px">
            <button class="btn secondary" id="saveBtn" title="ローカル保存に書き込み">保存</button>
            <button class="btn ghost" id="exportBtn" title="JSONをダウンロード">設定をエクスポート</button>
            <label class="btn ghost" for="importFile" title="JSONを読み込み">設定をインポート</label>
            <input id="importFile" type="file" accept="application/json" style="display:none">
            <span class="mini" id="saveStatus">（自動保存：入力ごとに保存されます）</span>
          </div>
        </details>
      </div>

      <div class="col-12 row" style="margin-top:8px">
        <button class="btn" id="calcBtn">計算する</button>
      <!--  <button class="btn secondary" id="resetBtn">クリア</button>-->
      </div>

      <div class="col-12 outputs">
        <div class="out">
          <h3>重量（Kg）</h3>
          <div class="val" id="weightVal">—</div>
          <div class="mini" id="weightNote"></div>
        </div>
        <div class="out">
          <h3>電流値（A）</h3>
          <div class="val" id="powerVal">—</div>
          <div class="mini" id="powerNote"></div>
        </div>
        <div class="out">
          <h3>消費電力（W）</h3>
          <div class="val" id="powerKW">—</div>
          <div class="mini" id="powerNote"> A x 200v</div>
        </div>
      </div>

      <div class="col-12 footer">
        <div>式: <code>重量 = (本体重量[機種] + Elevation 1+ 重量) × 台数</code>、<code>消費電力 = 消費電力[機種] × 台数</code></div>
        <div class="mini">保存はブラウザのローカルストレージに行われます（同一ブラウザ・同一端末で有効）。</div>
      </div>
    </div>
  </div>

  <script>
    const el = (id) => document.getElementById(id);
    const fmt = (num, unit) => Number.isFinite(num) ? new Intl.NumberFormat('ja-JP', { maximumFractionDigits: 2 }).format(num) + unit : '—';
    const STORAGE_KEY = "kinesys_calc_settings_v2";

    function getSettings(){
      return {
        weights: {
          CM:       parseFloat(el('wCM').value),
          Liftket:  parseFloat(el('wLiftket').value),
          Trolley:  parseFloat(el('wTrolley').value),
          Rotator:  parseFloat(el('wRotator').value),
        },
        extra: parseFloat(el('wExtra').value),
        powers: {
          CM:       parseFloat(el('pCM').value),
          Liftket:  parseFloat(el('pLiftket').value),
          Trolley:  parseFloat(el('pTrolley').value),
          Rotator:  parseFloat(el('pRotator').value),
        }
      }
    }

    function setSettings(obj){
      if(!obj) return;
      const {weights, extra, powers} = obj;
      if(weights){
        if(Number.isFinite(weights.CM)) el('wCM').value = weights.CM;
        if(Number.isFinite(weights.Liftket)) el('wLiftket').value = weights.Liftket;
        if(Number.isFinite(weights.Trolley)) el('wTrolley').value = weights.Trolley;
        if(Number.isFinite(weights.Rotator)) el('wRotator').value = weights.Rotator;
      }
      if(Number.isFinite(extra)) el('wExtra').value = extra;
      if(powers){
        if(Number.isFinite(powers.CM)) el('pCM').value = powers.CM;
        if(Number.isFinite(powers.Liftket)) el('pLiftket').value = powers.Liftket;
        if(Number.isFinite(powers.Trolley)) el('pTrolley').value = powers.Trolley;
        if(Number.isFinite(powers.Rotator)) el('pRotator').value = powers.Rotator;
      }
    }

    function saveToLocal(){
      const data = getSettings();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      el('saveStatus').textContent = "保存しました（自動保存ON）";
      setTimeout(()=> el('saveStatus').textContent = "（自動保存：入力ごとに保存されます）", 2000);
    }

    function loadFromLocal(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const data = JSON.parse(raw);
        setSettings(data);
      }catch(e){ console.warn(e); }
    }

    function exportJSON(){
      const blob = new Blob([JSON.stringify(getSettings(), null, 2)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "kinesys_calc_settings.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importJSON(file){
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const obj = JSON.parse(e.target.result);
          setSettings(obj);
          saveToLocal();
          calc();
        }catch(err){
          alert("JSONの読み込みに失敗しました。フォーマットを確認してください。");
        }
      };
      reader.readAsText(file, "utf-8");
    }

    function calc(){
      const model = el('model').value;
      const qty = parseFloat(el('qty').value);

      if(!model){
        el('weightVal').textContent = '—';
        el('powerVal').textContent = '—';
        el('powerKW').textContent  = '—';
        el('weightNote').textContent = '';
        el('powerNote').textContent = '';
        return;
      }

      const {weights, extra, powers} = getSettings();

      const baseWeight = weights[model];
      const unitPower  = powers[model];

      const q = Number.isFinite(qty) ? qty : 0;
      const bw = Number.isFinite(baseWeight) ? baseWeight : NaN;
      const ex = Number.isFinite(extra) ? extra : 0;
      const up = Number.isFinite(unitPower) ? unitPower : NaN;

      const totalWeight = (bw + ex) * q;
      const totalPower  = up * q;
      const totalPowerKW = Number.isFinite(totalPower) ? totalPower *200 : NaN;

      el('weightVal').textContent = fmt(totalWeight, ' kg');
      el('powerVal').textContent  = fmt(totalPower,  ' A');
      el('powerKW').textContent   = fmt(totalPowerKW, ' W');

      el('weightNote').textContent = `= (${bw ?? '—'} + ${ex ?? '—'}) × ${q}`;
      el('powerNote').textContent  = `= ${up ?? '—'} × ${q}`;
    }

    function resetAll(){
      el('model').value = '';
      el('qty').value = 0;
      ['wCM','wLiftket','wTrolley','wRotator','wExtra','pCM','pLiftket','pTrolley','pRotator']
        .forEach(id=> el(id).value = '');
      ['weightVal','powerVal','powerKW'].forEach(id=> el(id).textContent='—');
      ['weightNote','powerNote'].forEach(id=> el(id).textContent='');
      localStorage.removeItem(STORAGE_KEY);
      el('saveStatus').textContent = "保存データを削除しました";
      setTimeout(()=> el('saveStatus').textContent = "（自動保存：入力ごとに保存されます）", 2000);
    }

    // Event bindings
    el('calcBtn').addEventListener('click', calc);
    <!-- el('resetBtn').addEventListener('click', resetAll); -->
    el('saveBtn').addEventListener('click', saveToLocal);
    el('exportBtn').addEventListener('click', exportJSON);
    el('importFile').addEventListener('change', (e)=>{
      const file = e.target.files && e.target.files[0];
      if(file) importJSON(file);
      e.target.value = '';
    });

    // Auto-save on input
    ['model','qty','wCM','wLiftket','wTrolley','wRotator','wExtra','pCM','pLiftket','pTrolley','pRotator']
      .forEach(id=> el(id).addEventListener('input', ()=>{ saveToLocal(); calc(); }));

    // Init
    loadFromLocal();
    calc();
  </script>
</body>
</html>
